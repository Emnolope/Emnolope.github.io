<!DOCTYPE html>
<html>
<head>
  <title>Inventory App</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    .mode { display: none; }
    .mode.active { display: block; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; }
    #modeBtn { position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px; }
    #camera { width: 100vw; height: 100vh; object-fit: cover; cursor: pointer; }
    .placeholder { display: flex; align-items: center; justify-content: center; font-size: 3em; background: #333; color: white; }
  </style>
</head>
<body>
  <div id="app">
    <div id="mode0" class="mode">
      <video id="camera" autoplay playsinline onclick="rapidFireCapture()"></video>
    </div>
    <div id="mode1" class="mode placeholder">SLOW PICTURE MODE</div>
    <div id="mode2" class="mode placeholder">GALLERY VIEW</div>
    <div id="mode3" class="mode placeholder">TABLE VIEW</div>
    <div id="mode4" class="mode placeholder">
      <button onclick="pickFolder()">Pick Folder</button>
      <div id="output"></div>
    </div>
  </div>
  <button id="modeBtn" onclick="nextMode()"></button>
  <script>
// GLOBAL STATE
let dirHandle;
////// I/O OPERATIONS //////
async function listFiles() {
  const files = [];
  for await (const [name, handle] of dirHandle.entries()) {
    if (handle.kind === 'file') files.push(name);
  }
  return files;
}
async function readFile(filename) {
  const handle = await dirHandle.getFileHandle(filename);
  return await handle.getFile();
}
async function writeFile(filename, data) {
  const handle = await dirHandle.getFileHandle(filename, {create: true});
  const writer = await handle.createWritable();
  await writer.write(data);
  await writer.close();
}
async function deleteFile(filename) {
  await dirHandle.removeEntry(filename);
}
////// CAMERA //////
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video: true});
    document.getElementById('camera').srcObject = stream;
  } catch(e) { log('Camera failed:', e); }
}
function capturePhoto() {
  const canvas = document.createElement('canvas');
  const video = document.getElementById('camera');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  return canvas.toDataURL('image/jpeg');
}
////// HIGH LEVEL //////
async function saveInventoryItem(metadata, imageData) {
  if (!dirHandle) {
    log('No folder selected');
    return;
  }
  const filename = generateFilename(metadata);
  const response = await fetch(imageData);
  const blob = await response.blob();
  await writeFile(filename, blob);
  log(`üì∏ Saved: ${filename}`);
  return filename;
}
async function rapidFireCapture() {
  const imageData = capturePhoto();
  const metadata = createEmptyMetadata();
  await saveInventoryItem(metadata, imageData);
}
////// UI OPERATIONS //////
const modes = ['üì∏', 'üêå', 'üñºÔ∏è', 'üìä', '‚öôÔ∏è'];
let currentMode = 0;

function nextMode() {
  currentMode = (currentMode + 1) % modes.length;
  render();
}
function render() {
  document.querySelectorAll('.mode').forEach(m => m.classList.remove('active'));
  document.getElementById(`mode${currentMode}`).classList.add('active');
  document.getElementById('modeBtn').textContent = modes[currentMode];
}
function log(msg) {
  document.getElementById('output').innerHTML += `<div>${msg}</div>`;
}
function parseFilename(filename) {
  const [name, ext] = filename.split('.');
  const parts = name.split('_');
  if (parts.length !== 8) return { original: filename, valid: false };
  return {
    location: parts[0], sublocation: parts[1], types: parts[2],
    getFlag: parts[3], deleteFlag: parts[4], selectFlag: parts[5],
    item: parts[6], timestamp: parts[7], ext: ext || 'jpg', 
    original: filename, valid: true
  };
}
function generateFilename(meta) {
  return `${meta.location}_${meta.sublocation}_${meta.types}_${meta.getFlag}_${meta.deleteFlag}_${meta.selectFlag}_${meta.item}_${meta.timestamp}.${meta.ext}`;
}
function generateUUID() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hour = String(now.getHours()).padStart(2, '0');
  const min = String(now.getMinutes()).padStart(2, '0');
  const sec = String(now.getSeconds()).padStart(2, '0');
  const mil = String(now.getMilliseconds()).padStart(3, '0');
  return `${year}${month}${day}${hour}${min}${sec}${mil}`;
}

function createEmptyMetadata() 
  return {
    location: '', sublocation: '', types: '', 
    getFlag: '', deleteFlag: '', selectFlag: '', 
    item: '', timestamp: generateUUID(), ext: 'jpg'
  };
}
async function pickFolder() {
  try {
    dirHandle = await window.showDirectoryPicker();
    log('üìÅ Folder selected');
    const inventory = await loadInventory();
    log(`üìÑ Found ${inventory.length} valid items`);
  } catch (e) {
    log(`‚ùå ${e.message}`);
  }
}
async function loadInventory() {
  const filenames = await listFiles();
  return filenames.map(parseFilename);
}
async function updateInventoryItem(oldFilename, transformation) {
  const oldMetadata = parseFilename(oldFilename);
  const newMetadata = transformName(oldMetadata, transformation);
  const newFilename = generateFilename(newMetadata);
  const fileData = await readFile(oldFilename);
  await writeFile(newFilename, fileData);
  await deleteFile(oldFilename);
  return { old: oldFilename, new: newFilename };
}
window.onload = function init() {
  render();
  startCamera();
}
  </script>
</body>
</html>
